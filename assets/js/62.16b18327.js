(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{473:function(s,t,a){"use strict";a.r(t);var n=a(2),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"websocket模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#websocket模块"}},[s._v("#")]),s._v(" WebSocket模块")]),s._v(" "),t("h2",{attrs:{id:"设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设计"}},[s._v("#")]),s._v(" 设计")]),s._v(" "),t("h3",{attrs:{id:"client-客户端信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#client-客户端信息"}},[s._v("#")]),s._v(" Client 客户端信息")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Client 代理客户端信息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// uid不为空说明已经登录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// uid可能同一，但是key可能不同，说明一个用户有多个客户端连接（发送消息注意多端消息同步）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Client "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// key 客户端连接后生成的唯一key")]),s._v("\n  key "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// uid 用户id")]),s._v("\n  uid "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// email 用户邮箱")]),s._v("\n  email "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// socket 客户端连接对象")]),s._v("\n  socket "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("websocket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Conn\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// send 将数据发送到客户端")]),s._v("\n  send "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" model"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WSDataWrapper\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h3",{attrs:{id:"clientmanager-管理所有客户端信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#clientmanager-管理所有客户端信息"}},[s._v("#")]),s._v(" ClientManager 管理所有客户端信息")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ClientManager 客户端管理")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" ClientManager "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// onlineClients 在线客户端存储(登录态/游客)")]),s._v("\n  onlineClients "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("map")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// broadcast 广播数据链")]),s._v("\n  broadcast "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" model"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WSDataWrapper\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// register 客户端注册通道")]),s._v("\n  register "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Client\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// unregister 客户端关闭通道")]),s._v("\n  unregister "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Client\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("ClientManager简称"),t("code",[s._v("cm")])]),s._v(" "),t("p",[s._v("WebSocket简称"),t("code",[s._v("ws")])]),s._v(" "),t("h2",{attrs:{id:"请求-响应枚举"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#请求-响应枚举"}},[s._v("#")]),s._v(" 请求/响应枚举")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// req")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  Login      WSReqTypeEnum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("iota")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1 请求登陆二维码请求二维码登录（暂无）")]),s._v("\n  Heartbeat                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2 心跳包")]),s._v("\n  Authorize                           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3 登陆验证")]),s._v("\n  EmailLogin                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4 请求邮箱登录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// res")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  LoginUrl WSRespTypeEnum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("iota")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1 登录二维码返回")]),s._v("\n  LoginScanSuccess                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2 用户扫描成功等待授权")]),s._v("\n  LoginSuccess                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3 用户登录成功运回用户信息")]),s._v("\n  Message                             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4 新消息")]),s._v("\n  OnlineOfflineNotify                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 5 上下线通知")]),s._v("\n  InvalidateToken                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 6 使客户端的token失效，意味着客户端需要重新登录")]),s._v("\n  Black                               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 7 拉黑用户")]),s._v("\n  Mark                                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 8 消息标记")]),s._v("\n  Recall                              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 9 消息撒回")]),s._v("\n  Apply                               "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 10 好友申请")]),s._v("\n  MemberChange                        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 11 成员变动")]),s._v("\n  LoginEmail                          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 12 邮箱登录返回")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("h2",{attrs:{id:"前提"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前提"}},[s._v("#")]),s._v(" 前提")]),s._v(" "),t("ul",[t("li",[s._v("onlineClients 记录所有连接(游客态/登录态)")]),s._v(" "),t("li",[s._v("用户进入客户端，创建client，此时无id，无email")])]),s._v(" "),t("h2",{attrs:{id:"不同请求-响应流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#不同请求-响应流程"}},[s._v("#")]),s._v(" 不同请求/响应流程")]),s._v(" "),t("h3",{attrs:{id:"登陆验证-ws-req-3-客户端存在token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#登陆验证-ws-req-3-客户端存在token"}},[s._v("#")]),s._v(" 登陆验证 ws req=3  （客户端存在token）")]),s._v(" "),t("ul",[t("li",[s._v("请求登录，ws发送req=3的消息且携带token，验证成功后，用户登录成功后，将用户的uid绑定在该client上，代表该连接从游客态变成登录态，返回用户登录成功")]),s._v(" "),t("li",[s._v("该客户段返回登录成功后，cm向其他客户端发送res=5通知有新用户上线")])]),s._v(" "),t("h3",{attrs:{id:"邮箱登录-ws-req-4-客户端没有token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#邮箱登录-ws-req-4-客户端没有token"}},[s._v("#")]),s._v(" 邮箱登录 ws req=4 (客户端没有token)")]),s._v(" "),t("ul",[t("li",[s._v("用户请求邮箱登录，先ws发送req=4的消息且携带email，client绑定该邮箱")]),s._v(" "),t("li",[s._v("此时再http请求，登录成功后获取用户id，根据email，将uid绑定在client上，代表该连接从游客态变成登录态，最后返回用户登录成功")]),s._v(" "),t("li",[s._v("该客户段返回登录成功后，cm向其他客户端发送res=5通知有新用户上线")])])])}),[],!1,null,null,null);t.default=e.exports}}]);
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>思考｜源码｜GetX 刷新机制 | 放|FangJZSP</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="头像.jpg">
    <meta name="description" content="放，就这水平！！！">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/fang_blog/assets/css/0.styles.72d2c4fb.css" as="style"><link rel="preload" href="/fang_blog/assets/js/app.8dbc3baf.js" as="script"><link rel="preload" href="/fang_blog/assets/js/3.d5c9c33c.js" as="script"><link rel="preload" href="/fang_blog/assets/js/1.3f023f4a.js" as="script"><link rel="preload" href="/fang_blog/assets/js/94.1dbfc8cd.js" as="script"><link rel="prefetch" href="/fang_blog/assets/js/10.f0d76add.js"><link rel="prefetch" href="/fang_blog/assets/js/100.28282fe8.js"><link rel="prefetch" href="/fang_blog/assets/js/101.0a268033.js"><link rel="prefetch" href="/fang_blog/assets/js/102.323534cc.js"><link rel="prefetch" href="/fang_blog/assets/js/103.c0b41ce3.js"><link rel="prefetch" href="/fang_blog/assets/js/104.e449ff57.js"><link rel="prefetch" href="/fang_blog/assets/js/105.6a92b89a.js"><link rel="prefetch" href="/fang_blog/assets/js/106.980d44bf.js"><link rel="prefetch" href="/fang_blog/assets/js/107.ea0a7f8f.js"><link rel="prefetch" href="/fang_blog/assets/js/108.f30ca041.js"><link rel="prefetch" href="/fang_blog/assets/js/109.42415fa8.js"><link rel="prefetch" href="/fang_blog/assets/js/11.9cdb737f.js"><link rel="prefetch" href="/fang_blog/assets/js/110.69e898c9.js"><link rel="prefetch" href="/fang_blog/assets/js/111.2b6a92e0.js"><link rel="prefetch" href="/fang_blog/assets/js/112.3b443edd.js"><link rel="prefetch" href="/fang_blog/assets/js/113.170bb85f.js"><link rel="prefetch" href="/fang_blog/assets/js/114.ce720583.js"><link rel="prefetch" href="/fang_blog/assets/js/115.51550ce8.js"><link rel="prefetch" href="/fang_blog/assets/js/116.86c61c12.js"><link rel="prefetch" href="/fang_blog/assets/js/117.cd36d235.js"><link rel="prefetch" href="/fang_blog/assets/js/118.d2aa2818.js"><link rel="prefetch" href="/fang_blog/assets/js/119.dfc85732.js"><link rel="prefetch" href="/fang_blog/assets/js/12.c390a872.js"><link rel="prefetch" href="/fang_blog/assets/js/120.acc89b77.js"><link rel="prefetch" href="/fang_blog/assets/js/121.a2ca8c7b.js"><link rel="prefetch" href="/fang_blog/assets/js/122.34558db5.js"><link rel="prefetch" href="/fang_blog/assets/js/13.db6805ad.js"><link rel="prefetch" href="/fang_blog/assets/js/14.3ca931fc.js"><link rel="prefetch" href="/fang_blog/assets/js/15.bc9b8122.js"><link rel="prefetch" href="/fang_blog/assets/js/16.bbc72478.js"><link rel="prefetch" href="/fang_blog/assets/js/17.6aa92457.js"><link rel="prefetch" href="/fang_blog/assets/js/18.3b8c3544.js"><link rel="prefetch" href="/fang_blog/assets/js/19.3720bd61.js"><link rel="prefetch" href="/fang_blog/assets/js/20.3427a82e.js"><link rel="prefetch" href="/fang_blog/assets/js/21.0e0d11a1.js"><link rel="prefetch" href="/fang_blog/assets/js/22.4e83b8c9.js"><link rel="prefetch" href="/fang_blog/assets/js/23.4898c543.js"><link rel="prefetch" href="/fang_blog/assets/js/24.fa4424d2.js"><link rel="prefetch" href="/fang_blog/assets/js/25.a376524e.js"><link rel="prefetch" href="/fang_blog/assets/js/26.a31ca862.js"><link rel="prefetch" href="/fang_blog/assets/js/27.438348b8.js"><link rel="prefetch" href="/fang_blog/assets/js/28.91241cb6.js"><link rel="prefetch" href="/fang_blog/assets/js/29.58c07c4b.js"><link rel="prefetch" href="/fang_blog/assets/js/30.dc74b7f9.js"><link rel="prefetch" href="/fang_blog/assets/js/31.c4e67281.js"><link rel="prefetch" href="/fang_blog/assets/js/32.94559ffa.js"><link rel="prefetch" href="/fang_blog/assets/js/33.1edfe33f.js"><link rel="prefetch" href="/fang_blog/assets/js/34.bb7140a4.js"><link rel="prefetch" href="/fang_blog/assets/js/35.156904ee.js"><link rel="prefetch" href="/fang_blog/assets/js/36.0d2875d2.js"><link rel="prefetch" href="/fang_blog/assets/js/37.0119dcaa.js"><link rel="prefetch" href="/fang_blog/assets/js/38.ff81aade.js"><link rel="prefetch" href="/fang_blog/assets/js/39.95056f0b.js"><link rel="prefetch" href="/fang_blog/assets/js/4.5b40ea71.js"><link rel="prefetch" href="/fang_blog/assets/js/40.c5b78318.js"><link rel="prefetch" href="/fang_blog/assets/js/41.c4b55c58.js"><link rel="prefetch" href="/fang_blog/assets/js/42.f1e526c3.js"><link rel="prefetch" href="/fang_blog/assets/js/43.2da5ad5c.js"><link rel="prefetch" href="/fang_blog/assets/js/44.bcb10cbd.js"><link rel="prefetch" href="/fang_blog/assets/js/45.143c9d01.js"><link rel="prefetch" href="/fang_blog/assets/js/46.d57d89d5.js"><link rel="prefetch" href="/fang_blog/assets/js/47.b1a9d230.js"><link rel="prefetch" href="/fang_blog/assets/js/48.7cf175e1.js"><link rel="prefetch" href="/fang_blog/assets/js/49.d4b80112.js"><link rel="prefetch" href="/fang_blog/assets/js/5.e585f060.js"><link rel="prefetch" href="/fang_blog/assets/js/50.b294f1d7.js"><link rel="prefetch" href="/fang_blog/assets/js/51.92e6630a.js"><link rel="prefetch" href="/fang_blog/assets/js/52.bd1de398.js"><link rel="prefetch" href="/fang_blog/assets/js/53.4a698f74.js"><link rel="prefetch" href="/fang_blog/assets/js/54.6eed3b34.js"><link rel="prefetch" href="/fang_blog/assets/js/55.a510c147.js"><link rel="prefetch" href="/fang_blog/assets/js/56.92051efa.js"><link rel="prefetch" href="/fang_blog/assets/js/57.5ac2c3d8.js"><link rel="prefetch" href="/fang_blog/assets/js/58.b6b26eea.js"><link rel="prefetch" href="/fang_blog/assets/js/59.2d076bd8.js"><link rel="prefetch" href="/fang_blog/assets/js/6.731d207f.js"><link rel="prefetch" href="/fang_blog/assets/js/60.60804a5c.js"><link rel="prefetch" href="/fang_blog/assets/js/61.53ce21a1.js"><link rel="prefetch" href="/fang_blog/assets/js/62.16b18327.js"><link rel="prefetch" href="/fang_blog/assets/js/63.dd3f2e4d.js"><link rel="prefetch" href="/fang_blog/assets/js/64.a54ca66b.js"><link rel="prefetch" href="/fang_blog/assets/js/65.43e4c403.js"><link rel="prefetch" href="/fang_blog/assets/js/66.d2cc48c3.js"><link rel="prefetch" href="/fang_blog/assets/js/67.6dd9b8c9.js"><link rel="prefetch" href="/fang_blog/assets/js/68.c8ab3914.js"><link rel="prefetch" href="/fang_blog/assets/js/69.de6d733c.js"><link rel="prefetch" href="/fang_blog/assets/js/7.5a5b2d02.js"><link rel="prefetch" href="/fang_blog/assets/js/70.3f054ec7.js"><link rel="prefetch" href="/fang_blog/assets/js/71.cbf1c46f.js"><link rel="prefetch" href="/fang_blog/assets/js/72.695ebf98.js"><link rel="prefetch" href="/fang_blog/assets/js/73.a5889b43.js"><link rel="prefetch" href="/fang_blog/assets/js/74.3c210ea9.js"><link rel="prefetch" href="/fang_blog/assets/js/75.129b0790.js"><link rel="prefetch" href="/fang_blog/assets/js/76.45947065.js"><link rel="prefetch" href="/fang_blog/assets/js/77.12b75051.js"><link rel="prefetch" href="/fang_blog/assets/js/78.ec7c9b44.js"><link rel="prefetch" href="/fang_blog/assets/js/79.902cdaa3.js"><link rel="prefetch" href="/fang_blog/assets/js/8.4ed44d5b.js"><link rel="prefetch" href="/fang_blog/assets/js/80.842e525e.js"><link rel="prefetch" href="/fang_blog/assets/js/81.58ac443a.js"><link rel="prefetch" href="/fang_blog/assets/js/82.e0059c58.js"><link rel="prefetch" href="/fang_blog/assets/js/83.1abd0867.js"><link rel="prefetch" href="/fang_blog/assets/js/84.d7185511.js"><link rel="prefetch" href="/fang_blog/assets/js/85.16a92580.js"><link rel="prefetch" href="/fang_blog/assets/js/86.2e57a1f8.js"><link rel="prefetch" href="/fang_blog/assets/js/87.ccca66f8.js"><link rel="prefetch" href="/fang_blog/assets/js/88.abd24c06.js"><link rel="prefetch" href="/fang_blog/assets/js/89.7cfff85d.js"><link rel="prefetch" href="/fang_blog/assets/js/9.3437b5cf.js"><link rel="prefetch" href="/fang_blog/assets/js/90.3847167d.js"><link rel="prefetch" href="/fang_blog/assets/js/91.a6ed2f01.js"><link rel="prefetch" href="/fang_blog/assets/js/92.010d2d2a.js"><link rel="prefetch" href="/fang_blog/assets/js/93.3df292bd.js"><link rel="prefetch" href="/fang_blog/assets/js/95.94077f67.js"><link rel="prefetch" href="/fang_blog/assets/js/96.db9537fd.js"><link rel="prefetch" href="/fang_blog/assets/js/97.8128b970.js"><link rel="prefetch" href="/fang_blog/assets/js/98.b30e0be2.js"><link rel="prefetch" href="/fang_blog/assets/js/99.629a49a1.js">
    <link rel="stylesheet" href="/fang_blog/assets/css/0.styles.72d2c4fb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>放|FangJZSP</h3> <p class="description" data-v-59e6cb88>放，就这水平！！！</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Fang</span>
          
        <span data-v-59e6cb88>2024 - </span>
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fang_blog/" class="home-link router-link-active"><img src="/fang_blog/头像.jpg" alt="放|FangJZSP" class="logo"> <span class="site-name">放|FangJZSP</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fang_blog/" class="nav-link"><i class="iconfont reco-home"></i>
  随便看看的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      缝缝补补的文章
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fang_blog/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/服务器/" class="nav-link"><i class="undefined"></i>
  服务器
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/移动端/" class="nav-link"><i class="undefined"></i>
  移动端
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/编程思想/" class="nav-link"><i class="undefined"></i>
  编程思想
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/随想/" class="nav-link"><i class="undefined"></i>
  随想
</a></li></ul></div></div><div class="nav-item"><a href="/fang_blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  无关紧要的小标签
</a></div><div class="nav-item"><a href="/fang_blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  不知所措的时间线
</a></div><div class="nav-item"><a href="http://chat.relaxing.top/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-chat"></i>
  摸鱼聊天室
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系我吧~
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/FangJZSP" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/fang_blog/头像.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Fang
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>112</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>27</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/fang_blog/" class="nav-link"><i class="iconfont reco-home"></i>
  随便看看的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      缝缝补补的文章
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fang_blog/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/服务器/" class="nav-link"><i class="undefined"></i>
  服务器
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/移动端/" class="nav-link"><i class="undefined"></i>
  移动端
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/编程思想/" class="nav-link"><i class="undefined"></i>
  编程思想
</a></li><li class="dropdown-item"><!----> <a href="/fang_blog/categories/随想/" class="nav-link"><i class="undefined"></i>
  随想
</a></li></ul></div></div><div class="nav-item"><a href="/fang_blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  无关紧要的小标签
</a></div><div class="nav-item"><a href="/fang_blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  不知所措的时间线
</a></div><div class="nav-item"><a href="http://chat.relaxing.top/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-chat"></i>
  摸鱼聊天室
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系我吧~
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/FangJZSP" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>思考｜源码｜GetX 刷新机制</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Fang</span>
          
        <span data-v-59e6cb88>2024 - </span>
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">思考｜源码｜GetX 刷新机制</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Fang</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2024/4/8</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>移动端</span><span class="tag-item" data-v-8a445198>Flutter</span><span class="tag-item" data-v-8a445198>GetX</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="getx-刷新机制"><a href="#getx-刷新机制" class="header-anchor">#</a> GetX 刷新机制</h1> <p>代码仓库: <a href="https://github.com/FangJZSP/getx_study.git" target="_blank" rel="noopener noreferrer">https://github.com/FangJZSP/getx_study.git<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>刷新机制源码复盘</p> <h3 id="依赖注入"><a href="#依赖注入" class="header-anchor">#</a> 依赖注入</h3> <p>依赖注入的方式</p> <h4 id="put使用"><a href="#put使用" class="header-anchor">#</a> put使用</h4> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">/// 使用put进行依赖注入</span>
<span class="token keyword">var</span> controller <span class="token operator">=</span> <span class="token class-name">Get</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">XxxController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// demo中我们这么写</span>
<span class="token keyword">final</span> logic <span class="token operator">=</span> <span class="token class-name">Get</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">DependenceInjectionLogic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// getx 接口</span>
<span class="token keyword">class</span> _GetImpl <span class="token keyword">extends</span> <span class="token class-name">GetInterface</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/// 注释 // ignore: non_constant_identifier_names 是 Dart 分析器的一部分，它告诉分析器忽略接下来的一行中的特定代码规则检查</span>
<span class="token comment">/// 全局、只读变量 实现单例</span>
<span class="token comment">/// getX暴露出来给我们使用的接口</span>
<span class="token keyword">final</span> <span class="token class-name">Get</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">_GetImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// 拓展</span>
<span class="token keyword">extension</span> <span class="token class-name">Inst</span> <span class="token keyword">on</span> <span class="token class-name">GetInterface</span> <span class="token punctuation">{</span>

  <span class="token class-name">S</span> put<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">S</span> dependency<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> tag<span class="token punctuation">,</span>
        bool permanent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token class-name">InstanceBuilderCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> builder<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>put<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dependency<span class="token punctuation">,</span> tag<span class="token punctuation">:</span> tag<span class="token punctuation">,</span> permanent<span class="token punctuation">:</span> permanent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="put的逻辑"><a href="#put的逻辑" class="header-anchor">#</a> put的逻辑</h4> <p>看一下代码,学习一下</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">/// 点进去 GetInstance().put&lt;S&gt;(dependency, tag: tag, permanent: permanent);</span>
<span class="token comment">/// 主要的逻辑看来还是GetInstance中</span>
<span class="token keyword">class</span> <span class="token class-name">GetInstance</span> <span class="token punctuation">{</span>
  <span class="token comment">/// 项目经常使用的单例模式</span>
  <span class="token keyword">factory</span> <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _getInstance <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token class-name">GetInstance</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token class-name">GetInstance</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token class-name">GetInstance</span><span class="token operator">?</span> _getInstance<span class="token punctuation">;</span>

  <span class="token comment">/// 全局的数据都是存在 _singl 中，这是一个map类型</span>
  <span class="token comment">/// key：对象的runtimeType或者类的Type + tag</span>
  <span class="token comment">/// value：_InstanceBuilderFactory类，我们传入dependency对象会存入这个类中</span>
  <span class="token comment">/// 如果map中有key和传入key相同的数据，传入的数据将不会被存储</span>
  <span class="token comment">/// 也就是说相同类实例的对象，传入并不会被覆盖，只会存储第一条数据，后续被放弃</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> _InstanceBuilderFactory<span class="token punctuation">&gt;</span></span> _singl <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/// 在内存中注入一个实例' &lt;s&gt; '以便全局访问。</span>
  <span class="token comment">/// 不需要定义泛型类型' &lt;s&gt; '，因为它是从[dependency]推断出来的。</span>
  <span class="token comment">/// - [dependency]要注入的实例。</span>
  <span class="token comment">/// - [tag]可选，使用[tag]作为“id”来创建多个相同类型的记录&lt;[S]&gt;;</span>
  <span class="token comment">/// - [permanent]将Instance保存在内存中，而不是跟随Get.smartManagement规则。</span>
  <span class="token class-name">S</span> put<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">S</span> dependency<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token operator">?</span> tag<span class="token punctuation">,</span>
    bool permanent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token metadata function">@deprecated</span> <span class="token class-name">InstanceBuilderCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> builder<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 调用_insert方法 注册实例</span>
    <span class="token function">_insert</span><span class="token punctuation">(</span>
        isSingleton<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> tag<span class="token punctuation">,</span>
        permanent<span class="token punctuation">:</span> permanent<span class="token punctuation">,</span>
        builder<span class="token punctuation">:</span> builder <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> dependency<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 使用find方法返回实例</span>
    <span class="token keyword">return</span> find<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 向_signal map中开始存放实例</span>
  <span class="token keyword">void</span> _insert<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    bool<span class="token operator">?</span> isSingleton<span class="token punctuation">,</span>
    <span class="token class-name">String</span><span class="token operator">?</span> name<span class="token punctuation">,</span>
    bool permanent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    required <span class="token class-name">InstanceBuilderCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">,</span>
    bool fenix <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> key <span class="token operator">=</span> <span class="token function">_getKey</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_singl<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> dep <span class="token operator">=</span> _singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">/// 在 GetX 框架中，一个对象标记为 &quot;脏&quot;（dep.isDirty 返回 true）表示在没有观察者监听此对象时，它可以被清除或替换。</span>
      <span class="token comment">/// 这是一个内存优化策略，让没有用到的对象可以被合适地清理，这样就可以防止内存的浪费并且提升性能。</span>
      <span class="token comment">/// 为什么要检查 dep.isDirty 并给 _singl[key] 重新赋值？</span>
      <span class="token comment">/// 如果map _singl 中已有对应的 key，代码会检查对应的值 dep 是否存在，并检查它是否被标记为 &quot;脏&quot; (isDirty 是 true）。</span>
      <span class="token comment">/// 如果满足这些条件，那么代码会用新的 _InstanceBuilderFactory 替代旧的，这样可以释放旧的 dep 对象所占用的内存，用新的 _InstanceBuilderFactory 对象代替，从而达到内存管理的目的。</span>
      <span class="token comment">/// 这样的策略就是在一定的程度上最优化了内存的使用，保留必要的对象，且及时清理不再需要的对象。这就是为什么有 dep.isDirty 的判断，并且在该对象 &quot;脏&quot; 的情况下，重新给 _singl[key] 赋值。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dep <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> dep<span class="token punctuation">.</span>isDirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _InstanceBuilderFactory<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
          isSingleton<span class="token punctuation">,</span>
          builder<span class="token punctuation">,</span>
          permanent<span class="token punctuation">,</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          fenix<span class="token punctuation">,</span>
          name<span class="token punctuation">,</span>
          lateRemove<span class="token punctuation">:</span> dep <span class="token operator">as</span> _InstanceBuilderFactory<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      _singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _InstanceBuilderFactory<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        isSingleton<span class="token punctuation">,</span>
        builder<span class="token punctuation">,</span>
        permanent<span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        fenix<span class="token punctuation">,</span>
        name<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 根据类型(也可以是名称)生成键，以便在map中注册Instance Builder。</span>
  <span class="token class-name">String</span> <span class="token function">_getKey</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">?</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> name <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> type<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> type<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><h4 id="find逻辑"><a href="#find逻辑" class="header-anchor">#</a> find逻辑</h4> <ul><li>find方法 就是从map中取数据的操作</li></ul> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">// 项目中我们这么用 -&gt; 点进去看方法</span>
<span class="token keyword">final</span> state <span class="token operator">=</span> <span class="token class-name">Get</span>
    <span class="token punctuation">.</span>find<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DependenceInjectionLogic</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>state<span class="token punctuation">;</span>

<span class="token class-name">S</span> find<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> tag<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">GetInstance</span> <span class="token punctuation">{</span>

  <span class="token keyword">factory</span> <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _getInstance <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token class-name">GetInstance</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token class-name">GetInstance</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token class-name">GetInstance</span><span class="token operator">?</span> _getInstance<span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> _InstanceBuilderFactory<span class="token punctuation">&gt;</span></span> _singl <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">_getKey</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">?</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> name <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> type<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> type<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool isRegistered<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> tag<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _singl<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token function">_getKey</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">S</span> find<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> tag<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> key <span class="token operator">=</span> <span class="token function">_getKey</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 如果含有该key说明注册过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRegistered<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/// 再判断 _singl 中是否含有该key的value，有则取，无则抛异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/// 顺带把tag的情况 一起带着抛</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token string-literal"><span class="token string">'Class &quot;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression"><span class="token class-name">S</span></span></span><span class="token string">&quot; is not registered'</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token string-literal"><span class="token string">'Class &quot;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression"><span class="token class-name">S</span></span></span><span class="token string">&quot; with tag &quot;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">tag</span></span><span class="token string">&quot; is not registered'</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">final</span> i <span class="token operator">=</span> _initDependencies<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> i <span class="token operator">?</span><span class="token operator">?</span> _singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">getDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">as</span> <span class="token class-name">S</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">/// 连key都没有，直接抛出异常</span>
      <span class="token comment">// ignore: lines_longer_than_80_chars</span>
      <span class="token keyword">throw</span> <span class="token string-literal"><span class="token string">'&quot;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression"><span class="token class-name">S</span></span></span><span class="token string">&quot; not found. You need to call &quot;Get.put(</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression"><span class="token class-name">S</span></span></span><span class="token string">())&quot; or &quot;Get.lazyPut(()=&gt;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression"><span class="token class-name">S</span></span></span><span class="token string">())&quot;'</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 这段话的意思是，初始化一个类实例 S（或标签）的依赖项。如果这是一个控制器，它将开始生命周期过程。</span>
<span class="token comment">/// 如果 Get.smartManagement 标记为 SmartManagement.full 或 SmartManagement.keepFactory，则可以选择将当前路由与实例的生命周期关联起来。</span>
<span class="token comment">/// 只有当使用 Get.create() 时才标记 isInit（不适用于单例访问）。如果未初始化，则返回实例，这是 Get.create() 正常工作所必需的。</span>
<span class="token class-name">S</span><span class="token operator">?</span> _initDependencies<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> key <span class="token operator">=</span> <span class="token function">_getKey</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据 S 和 name 获取键</span>
  <span class="token keyword">final</span> isInit <span class="token operator">=</span> _singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span>isInit<span class="token punctuation">;</span> <span class="token comment">// 检查当前实例是否已经被初始化</span>
  <span class="token class-name">S</span><span class="token operator">?</span> i<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isInit<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果实例尚未被初始化</span>
    i <span class="token operator">=</span> _startController<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动控制器并返回实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span>isSingleton<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果实例是 单例模式</span>
      _singl<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span>isInit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标记该实例已被初始化</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Get</span><span class="token punctuation">.</span>smartManagement <span class="token operator">!=</span> <span class="token class-name">SmartManagement</span><span class="token punctuation">.</span>onlyBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果 smartManagement 设置为非 onlyBuilder 模式</span>
        <span class="token class-name">RouterReportManager</span><span class="token punctuation">.</span><span class="token function">reportDependencyLinkedToRoute</span><span class="token punctuation">(</span><span class="token function">_getKey</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 报告路由与实例的依赖关系</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> i<span class="token punctuation">;</span> <span class="token comment">// 返回实例</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 通过它的 [builderFunc] 获取实际的实例，或者获取持久化的实例。</span>
<span class="token class-name">S</span> <span class="token function">getDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isSingleton<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果这个实例是单例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dependency <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果这个单例还未被初始化</span>
      <span class="token function">_showInitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 显示初始化的日志</span>
      dependency <span class="token operator">=</span> <span class="token function">builderFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过 builderFunc 来构建这个实例</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> dependency<span class="token operator">!</span><span class="token punctuation">;</span> <span class="token comment">// 返回这个单例</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 如果这个实例不是单例</span>
    <span class="token keyword">return</span> <span class="token function">builderFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接通过 builderFunc 来构建并返回这个实例</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><h3 id="刷新机制"><a href="#刷新机制" class="header-anchor">#</a> 刷新机制</h3> <h4 id="getbuilder"><a href="#getbuilder" class="header-anchor">#</a> GetBuilder</h4> <h5 id="使用场景展示一下"><a href="#使用场景展示一下" class="header-anchor">#</a> 使用场景展示一下</h5> <h5 id="getbuilder-内置回收机制-刷新逻辑"><a href="#getbuilder-内置回收机制-刷新逻辑" class="header-anchor">#</a> GetBuilder 内置回收机制 + 刷新逻辑</h5> <p>代码如下 -&gt; 精简版</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">typedef</span> <span class="token class-name">GetControllerBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">DisposableInterface</span><span class="token punctuation">&gt;</span></span> <span class="token operator">=</span> <span class="token class-name">Widget</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
    <span class="token class-name">T</span> controller<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// GetBuilder继承了GetxController 和 StatefulWidget</span>
<span class="token keyword">class</span> <span class="token class-name">GetBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">GetxController</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">GetControllerBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">;</span>
  <span class="token keyword">final</span> bool global<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token operator">?</span> id<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token operator">?</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">final</span> bool autoRemove<span class="token punctuation">;</span>
  <span class="token keyword">final</span> bool assignId<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span><span class="token operator">?</span> filter<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">GetBuilderState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> state<span class="token punctuation">)</span><span class="token operator">?</span> initState<span class="token punctuation">,</span>
      dispose<span class="token punctuation">,</span>
      didChangeDependencies<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">GetBuilder</span> oldWidget<span class="token punctuation">,</span> <span class="token class-name">GetBuilderState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> state<span class="token punctuation">)</span><span class="token operator">?</span>
  didUpdateWidget<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">T</span><span class="token operator">?</span> init<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token class-name">GetBuilder</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>init<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>global <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>builder<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autoRemove <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>assignId <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>initState<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filter<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dispose<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>didChangeDependencies<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>didUpdateWidget<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">GetBuilderState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">GetBuilderState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">GetBuilderState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">GetxController</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">with</span> <span class="token class-name">GetStateUpdaterMixin</span> <span class="token punctuation">{</span>
  <span class="token class-name">T</span><span class="token operator">?</span> controller<span class="token punctuation">;</span>

  <span class="token comment">/// 是否 是类型为 T 的实例的创建者</span>
  bool<span class="token operator">?</span> _isCreator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token class-name">VoidCallback</span><span class="token operator">?</span> _remove<span class="token punctuation">;</span>
  <span class="token class-name">Object</span><span class="token operator">?</span> _filter<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    widget<span class="token punctuation">.</span>initState<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 通过传入 GetBuilder上泛型获取相应GetXController实例</span>
    <span class="token comment">/// eg : DependenceInjectionLogic? init,</span>
    <span class="token keyword">var</span> isRegistered <span class="token operator">=</span> <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isRegistered<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// global说明所有的ui都能用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>widget<span class="token punctuation">.</span>global<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRegistered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/// 存在：直接使用 init传入的实例 默认无效</span>
        <span class="token comment">/// isPrepared 用来 检查特定类型 S 的引用是否已被准备好（即已在内存中注册），且还未被初始化。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isPrepared<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          _isCreator <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          _isCreator <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        controller <span class="token operator">=</span> <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/// 不存在: 使用init传入的实例</span>
        controller <span class="token operator">=</span> widget<span class="token punctuation">.</span>init<span class="token punctuation">;</span>
        _isCreator <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>put<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>controller<span class="token operator">!</span><span class="token punctuation">,</span> tag<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      controller <span class="token operator">=</span> widget<span class="token punctuation">.</span>init<span class="token punctuation">;</span>
      _isCreator <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      controller<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>widget<span class="token punctuation">.</span>filter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _filter <span class="token operator">=</span> widget<span class="token punctuation">.</span>filter<span class="token operator">!</span><span class="token punctuation">(</span>controller<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token function">_subscribeToController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 确保订阅了 controller 的更新。</span>
  <span class="token comment">/// 当 _filter 非空时，意味这不是所有的更新都会导致 widget 更新，而是当 _filter 判断为真时才更新。</span>
  <span class="token comment">/// 当 _filter 为空时，所有的更新都会触发 widget 的更新。</span>
  <span class="token keyword">void</span> <span class="token function">_subscribeToController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _remove<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _remove <span class="token operator">=</span> <span class="token punctuation">(</span>widget<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> controller<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>

      <span class="token comment">/// 小插曲: 怎么理解addListener方法</span>
      <span class="token comment">/// addListener 是一个常用于处理事件或数据更改的函数。 </span>
      <span class="token comment">/// -&gt; eg: 小明坐公交车 捡到钱 和 没捡到钱  当知道小明捡到钱 通知小明把钱交给警察叔叔 捡到钱相当于知道值变了 通知调用setState方法</span>
      <span class="token comment">/// 通常情况下，你会将一个回调函数 作为参数传给 addListener，这个函数会在某个特定的事件发生 (比如数据变化）时被自动调用。</span>
      <span class="token comment">/// 添加监听回调</span>
      <span class="token comment">/// 标签 &lt;GetBuild核心&gt;</span>
      _filter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> _filterUpdate <span class="token punctuation">:</span> getUpdate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
        <span class="token punctuation">:</span> controller<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addListenerId</span><span class="token punctuation">(</span>

      <span class="token comment">/// 添加监听回调，必须设置id，update刷新的时候也必须写上配套的id</span>
      widget<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      _filter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> _filterUpdate <span class="token punctuation">:</span> getUpdate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// _filterUpdate 这个方法用于当过滤条件改变时，调用 getUpdate 来进行相应的更新操作</span>
  <span class="token keyword">void</span> <span class="token function">_filterUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newFilter <span class="token operator">=</span> widget<span class="token punctuation">.</span>filter<span class="token operator">!</span><span class="token punctuation">(</span>controller<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFilter <span class="token operator">!=</span> _filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _filter <span class="token operator">=</span> newFilter<span class="token punctuation">;</span>

      <span class="token comment">///getUpdate()逻辑就是 setState()，刷新当前GetBuilder</span>
      <span class="token function">getUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    widget<span class="token punctuation">.</span>dispose<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// autoRemove可以控制是否自动回收GetXController实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_isCreator<span class="token operator">!</span> <span class="token operator">||</span> widget<span class="token punctuation">.</span>assignId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/// 默认为true：默认开启自动回收</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>widget<span class="token punctuation">.</span>autoRemove <span class="token operator">&amp;&amp;</span> <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isRegistered<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tag<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    _remove<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    controller <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    _isCreator <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    _remove <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    _filter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">didChangeDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">didChangeDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    widget<span class="token punctuation">.</span>didChangeDependencies<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">didUpdateWidget</span><span class="token punctuation">(</span><span class="token class-name">GetBuilder</span> oldWidget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">didUpdateWidget</span><span class="token punctuation">(</span>oldWidget <span class="token operator">as</span> <span class="token class-name">GetBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// to avoid conflicts when modifying a &quot;grouped&quot; id list.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldWidget<span class="token punctuation">.</span>id <span class="token operator">!=</span> widget<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_subscribeToController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    widget<span class="token punctuation">.</span>didUpdateWidget<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>oldWidget<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> widget<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>controller<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 这个混入影响了一个 GetStateUpdater 函数，它可能被 GetBuilder()、SimpleBuilder()（或类似的）用来满足 GetStateUpdate 签名，用以替换 StateSetter。</span>
<span class="token comment">/// 这避免了控件处于 dispose() 状态时可能（但极其罕见）遇到的问题，并且将 API 从不优雅的 fn((){}) 中抽象出来。</span>
<span class="token comment">/// 函数签名通常指的是函数的名称，以及输入参数的数量、顺序和类型，还有函数返回值的类型</span>
<span class="token keyword">mixin</span> <span class="token class-name">GetStateUpdaterMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">on</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// To avoid the creation of an anonym function to be GC later.</span>
  <span class="token comment">// ignore: prefer_function_declarations_over_variables</span>

  <span class="token comment">/// Experimental method to replace setState((){});</span>
  <span class="token comment">/// Used with GetStateUpdate.</span>
  <span class="token keyword">void</span> <span class="token function">getUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mounted<span class="token punctuation">)</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br></div></div><h5 id="update"><a href="#update" class="header-anchor">#</a> Update</h5> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">GetxController</span> <span class="token keyword">extends</span> <span class="token class-name">DisposableInterface</span>
    <span class="token keyword">with</span> <span class="token class-name">ListenableMixin</span><span class="token punctuation">,</span> <span class="token class-name">ListNotifierMixin</span> <span class="token punctuation">{</span>

  <span class="token comment">/// 每次调用 update() 时都会重建 GetBuilder；</span>
  <span class="token comment">/// 可以接受一个 id 的列表，只会更新匹配的 GetBuilder(id: )，而这些 id 可以在 GetBuilders 之间重用，像组标签一样。</span>
  <span class="token comment">/// 只有当条件为真时，更新才会通知这些控件。</span>
  <span class="token comment">/// condition : 是否刷新一个判断条件，默认为true（假设必须某个id大于3才能刷新：update([1, 2, 3, 4], index &gt; 3) ）</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> ids<span class="token punctuation">,</span> bool condition <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ids <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">/// ids：和上面的GetBuilder中设置的id对应起来了，可刷新对应设置id的GetBuilder</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> id <span class="token keyword">in</span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">refreshGroup</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h5 id="refresh"><a href="#refresh" class="header-anchor">#</a> refresh</h5> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>
<span class="token comment">/// GetStateUpdate的方法体是setState，每创建一个GetBuilder，都会在_updaters列表中，增加一个GetStateUpdate实例</span>
<span class="token keyword">typedef</span> <span class="token class-name">GetStateUpdate</span> <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ListNotifier</span> <span class="token keyword">implements</span> <span class="token class-name">Listenable</span> <span class="token punctuation">{</span>
  <span class="token comment">/// _updaters中泛型就是一个方法</span>
  <span class="token comment">/// _updaters 列表用于存储当前添加的所有监听器</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetStateUpdate</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> _updaters <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetStateUpdate</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/// id情况下的更新方法</span>
  <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">GetStateUpdate</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> _updatersGroupIds <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">GetStateUpdate</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 更新所有</span>
  <span class="token metadata function">@protected</span>
  <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">_debugAssertNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 标签 &lt;GetBuild核心&gt;</span>
    <span class="token function">_notifyUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_notifyUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> element <span class="token keyword">in</span> _updaters<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/// setState ！！！</span>
      element<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_notifyIdUpdate</span><span class="token punctuation">(</span><span class="token class-name">Object</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_updatersGroupIds<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> listGroup <span class="token operator">=</span> _updatersGroupIds<span class="token operator">!</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> listGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 更新对应相应</span>
  <span class="token metadata function">@protected</span>
  <span class="token keyword">void</span> <span class="token function">refreshGroup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">_debugAssertNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_notifyIdUpdate</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Disposer</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">GetStateUpdate</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">_debugAssertNotDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 添加监听器到 GetBuilder，监听器是一个包含 setState() 的函数</span>
    _updaters<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 当GetBuilder被更新后，返回的 dispose 函数将被调用，从 _updaters 列表中移除当前添加的监听器</span>
    <span class="token comment">/// 这样可以防止因重新构建时重复通知监听器而产生的性能问题</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _updaters<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Disposer</span> <span class="token function">addListenerId</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token operator">?</span> key<span class="token punctuation">,</span> <span class="token class-name">GetStateUpdate</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _updatersGroupIds<span class="token operator">!</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetStateUpdate</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/// 在GetBuilder中添加的监听就是一个方法参数，方法体里面就是 setState()</span>
    _updatersGroupIds<span class="token operator">!</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _updatersGroupIds<span class="token operator">!</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">/// ... 省略</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><h5 id="getbuilder总结"><a href="#getbuilder总结" class="header-anchor">#</a> GetBuilder总结</h5> <p>GetBuilder 的刷新机制主要由以下几个步骤组成：</p> <ol><li><p>GetBuilder 组件在初始化时，会将包含 setState() 方法的监听器添加到其 _updaters 列表中。setState() 是导致组件重新构建的主要方法。</p></li> <li><p>当你通过调用 update() 方法来更新 GetBuilder 时，它会触发所有在 _updaters 列表中的监听器，从而让所有相关的 GetBuilder
组件重新构建。</p></li> <li><p>重新构建完成后，GetBuilder 会通过调用返回的 Disposer 函数来从 _updaters 列表中移除相关的监听器。这样做可以防止因重复通知监听器而造成的性能问题。</p> <p>简单来说，GetBuilder 的刷新机制基于监听器模式，通过监听器的添加和移除，实现了对特定组件，更新，而非全局刷新。</p></li></ol> <h4 id="obx刷新机制"><a href="#obx刷新机制" class="header-anchor">#</a> Obx刷新机制</h4> <h5 id="小总结"><a href="#小总结" class="header-anchor">#</a> 小总结</h5> <ul><li>变量上：在基础类型，实体以及列表之类的数据类型，作者都封装了一套Rx类型，快捷在数据后加obs</li> <li><ul><li>例如：RxString msg = &quot;test&quot;.obs（var msg = &quot;test&quot;.obs）</li></ul></li> <li>更新上：基础类型直接更新数据就行，实体类需要以 .refresh() 的形式</li> <li>使用上：使用这类变量，一般要加上 .value</li></ul> <p>Obx刷新机制，最有趣应该就是变量改变后，包裹该变量的Obx会自动刷新</p> <p>可以得出一个概念，最好obx只管理最小的ui，这样效果是最好的</p> <h5 id="rx变量"><a href="#rx变量" class="header-anchor">#</a> Rx变量</h5> <p>以RxInt为例子</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">RxInt</span> <span class="token keyword">extends</span> <span class="token class-name">Rx</span><span class="token generics"><span class="token punctuation">&lt;</span>int<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token class-name">RxInt</span><span class="token punctuation">(</span>int initial<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Addition operator.</span>
  <span class="token class-name">RxInt</span> <span class="token keyword">operator</span> <span class="token operator">+</span><span class="token punctuation">(</span>int other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> value <span class="token operator">+</span> other<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Subtraction operator.</span>
  <span class="token class-name">RxInt</span> <span class="token keyword">operator</span> <span class="token operator">-</span><span class="token punctuation">(</span>int other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> value <span class="token operator">-</span> other<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// .obs 语法糖</span>
<span class="token keyword">extension</span> <span class="token class-name">IntExtension</span> <span class="token keyword">on</span> int <span class="token punctuation">{</span>
  <span class="token comment">/// Returns a `RxInt` with [this] `int` as initial value.</span>
  <span class="token class-name">RxInt</span> <span class="token keyword">get</span> obs <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">RxInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>看一下Rx父类</li></ul> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>
<span class="token comment">/// 继承自_RxImpl</span>
<span class="token keyword">class</span> <span class="token class-name">Rx</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> _RxImpl<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token class-name">Rx</span><span class="token punctuation">(</span><span class="token class-name">T</span> initial<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">dynamic</span> <span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>value <span class="token operator">as</span> <span class="token keyword">dynamic</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">on</span> <span class="token class-name">Exception</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression"><span class="token class-name">T</span></span></span><span class="token string"> has not method [toJson]'</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>引出一个非常重要的类 =&gt; _RxImpl
<strong>简单来看</strong></p> <ul><li>_RxImpl 类继承了 RxNotifier 并且 with 了 RxObjectMixin</li> <li>这个类挺复杂的， RxNotifier 和 RxObjectMixin 内容很多</li> <li>代码很多，先展示下完整代码</li> <li><ul><li>RxNotifier猜名字就是负责通知</li></ul></li> <li><ul><li>RxObjectMixin猜名字 是Rx类型的父类 -&gt; 猜错了 只是提供代码重用技术</li></ul></li></ul> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">/// Rx 的基础类，管理所有类型的流逻辑。</span>
<span class="token comment">/// &quot;流逻辑&quot;是在编程中处理数据流的概念和技术，通常在处理异步数据源时使用，如用户输入、文件、Web API请求等。</span>
<span class="token comment">/// 流通常被视为可处理的数据元素序列，这些元素随时间推移而产生。流可以被观察（订阅）和操作（如筛选、转化、组合等），这就是所谓的&quot;流逻辑&quot;。</span>
<span class="token comment">/// </span>
<span class="token comment">/// with 是一个关键字，主要用于 mixin 的实现。</span>
<span class="token comment">/// Mixin 是一种代码重用的技术，允许你在一个类中使用其他类的代码。</span>
<span class="token comment">/// 这个关键字使得你可以在不使用继承的情况下，将其他类的代码和功能整合到一个类中。</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> _RxImpl<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">RxNotifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">with</span> <span class="token class-name">RxObjectMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token function">_RxImpl</span><span class="token punctuation">(</span><span class="token class-name">T</span> initial<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/// _values是RxObjectMixin中的成员属性</span>
    _value <span class="token operator">=</span> initial<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">addError</span><span class="token punctuation">(</span><span class="token class-name">Object</span> error<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name">StackTrace</span><span class="token operator">?</span> stackTrace<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subject<span class="token punctuation">.</span><span class="token function">addError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> stackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 这个函数用于将数据流中的每一项都通过一个你提供的函数（mapper）转换成新的形式。</span>
  <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> map<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">R</span> <span class="token function">mapper</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token operator">?</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 这个函数接收一个函数作为参数，这个函数会用当前值作为参数调用。然后将当前值传给 subject。</span>
  <span class="token comment">/// 当 subject 状态变化了，所有的订阅者都会更新。</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token operator">?</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// subject是NotifyManager中的成员属性</span>
    subject<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token class-name">T</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> firstRebuild <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstRebuild<span class="token punctuation">;</span>
    value <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>firstRebuild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      subject<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RxNotifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token operator">=</span> <span class="token class-name">RxInterface</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">with</span> <span class="token class-name">NotifyManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>


<span class="token comment">/// 看名字就像一个 通知管理者</span>
<span class="token keyword">mixin</span> <span class="token class-name">NotifyManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token comment">/// 声明并初始化了一个类型为 GetStream 的流对象 subject</span>
  <span class="token class-name">GetStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> subject <span class="token operator">=</span> <span class="token class-name">GetStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 一个包含流及其订阅对象的map _subscriptions， key是Stream，value是StreamSubscription列表</span>
  <span class="token keyword">final</span> _subscriptions <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetStream</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StreamSubscription</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/// 订阅该stream的streamSubscription列表不为空 则可以更新</span>
  bool <span class="token keyword">get</span> canUpdate <span class="token operator">=</span><span class="token operator">&gt;</span> _subscriptions<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">;</span>

  <span class="token comment">/// 内置callBack 的 GetStream类型</span>
  <span class="token comment">/// 这个方法接受一个 GetStream&lt;T&gt; 对象作为参数，并检查它是否已在 _subscriptions 中。</span>
  <span class="token comment">/// 如果不在，它就创建一个订阅到该流的 StreamSubscription，并将其添加到 _subscriptions 中。</span>
  <span class="token comment">/// 这样，当流发出新的数据时，它就会接收并将其添加到 subject 中。</span>
  <span class="token keyword">void</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">GetStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> rxGetx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_subscriptions<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>rxGetx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> subs <span class="token operator">=</span> rxGetx<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subject<span class="token punctuation">.</span>isClosed<span class="token punctuation">)</span> subject<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> listSubscriptions <span class="token operator">=</span> _subscriptions<span class="token punctuation">[</span>rxGetx<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamSubscription</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      listSubscriptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 监听这个事情</span>
  <span class="token class-name">StreamSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> onData<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token class-name">Function</span><span class="token operator">?</span> onError<span class="token punctuation">,</span>
    <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onDone<span class="token punctuation">,</span>
    bool<span class="token operator">?</span> cancelOnError<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      subject<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
        onData<span class="token punctuation">,</span>
        onError<span class="token punctuation">:</span> onError<span class="token punctuation">,</span>
        onDone<span class="token punctuation">:</span> onDone<span class="token punctuation">,</span>
        cancelOnError<span class="token punctuation">:</span> cancelOnError <span class="token operator">?</span><span class="token operator">?</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 关闭</span>
  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _subscriptions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>getStream<span class="token punctuation">,</span> _subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> subscription <span class="token keyword">in</span> _subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subscription<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _subscriptions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    subject<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">///  on 说明只能在 NotifyManager 这个类或这个类的子类 上用 </span>
<span class="token keyword">mixin</span> <span class="token class-name">RxObjectMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">on</span> <span class="token class-name">NotifyManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  late <span class="token class-name">T</span> _value<span class="token punctuation">;</span>

  <span class="token comment">/// 将 value 直接更新并将其添加到数据流中</span>
  <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subject<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool firstRebuild <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  bool sentToStream <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">/// Same as `toString()` but using a getter.</span>
  <span class="token class-name">String</span> <span class="token keyword">get</span> string <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Returns the json representation of `value`.</span>
  <span class="token keyword">dynamic</span> <span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">;</span>

  <span class="token comment">/// This equality override works for _RxImpl instances and the internal</span>
  <span class="token comment">/// values.</span>
  <span class="token metadata function">@override</span>
  <span class="token comment">// ignore: avoid_equals_and_hash_code_on_mutable_classes</span>
  bool <span class="token keyword">operator</span> <span class="token operator">==</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Todo, find a common implementation for the hashCode of different Types.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">is</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value <span class="token operator">==</span> o<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">is</span> <span class="token class-name">RxObjectMixin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token keyword">return</span> value <span class="token operator">==</span> o<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token comment">// ignore: avoid_equals_and_hash_code_on_mutable_classes</span>
  int <span class="token keyword">get</span> hashCode <span class="token operator">=</span><span class="token operator">&gt;</span> _value<span class="token punctuation">.</span>hashCode<span class="token punctuation">;</span>

  <span class="token comment">/// 一个value的setter函数。</span>
  <span class="token comment">/// 更新value的值，并将其添加到数据流中，更新观察的小部件</span>
  <span class="token comment">/// subject.add(_value)，内部逻辑是自动刷新操作</span>
  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token class-name">T</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subject<span class="token punctuation">.</span>isClosed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    sentToStream <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_value <span class="token operator">==</span> val <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>firstRebuild<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    firstRebuild <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    _value <span class="token operator">=</span> val<span class="token punctuation">;</span>
    sentToStream <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    subject<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 在返回 _value 值之前，会添加一个监听器到 subject。</span>
  <span class="token comment">/// &lt;getValue&gt;</span>
  <span class="token class-name">T</span> <span class="token keyword">get</span> value <span class="token punctuation">{</span>
    <span class="token class-name">RxInterface</span><span class="token punctuation">.</span>proxy<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> _value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">get</span> stream <span class="token operator">=</span><span class="token operator">&gt;</span> subject<span class="token punctuation">.</span>stream<span class="token punctuation">;</span>

  <span class="token comment">/// 立即使用当前value启动流</span>
  <span class="token class-name">StreamSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">listenAndPump</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span> event<span class="token punctuation">)</span> onData<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Function</span><span class="token operator">?</span> onError<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onDone<span class="token punctuation">,</span> bool<span class="token operator">?</span> cancelOnError<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> subscription <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>
      onData<span class="token punctuation">,</span>
      onError<span class="token punctuation">:</span> onError<span class="token punctuation">,</span>
      onDone<span class="token punctuation">:</span> onDone<span class="token punctuation">,</span>
      cancelOnError<span class="token punctuation">:</span> cancelOnError<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    subject<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> subscription<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// bindStream函数就是用来将一个Stream&lt;T&gt;绑定到一个Rx&lt;T&gt;对象上，以此来保持它们的值同步更新。</span>
  <span class="token keyword">void</span> <span class="token function">bindStream</span><span class="token punctuation">(</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> listSubscriptions <span class="token operator">=</span> _subscriptions<span class="token punctuation">[</span>subject<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamSubscription</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    listSubscriptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value <span class="token operator">=</span> va<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div><p>简化 _RxImpl，把需要关注的内容展示出来：此处有几个需要重点关注的点</p> <ul><li>RxInt是一个内置callback的数据类型（GetStream）</li> <li>RxInt的value变量改变的时候（set value），会触发subject.add(_value)，猜测内部逻辑是自动刷新操作</li> <li>获取RxInt的value变量的时候（get value），会有一个添加监听的操作 RxInterface.proxy?.addListener(subject);</li></ul> <p>看样子subject很关键 我们看一下subject，它是一个GetStream实例</p> <p>那为啥GetStream的add会有刷新操作</p> <ul><li>调用add方法时候，会调用 _notifyData 方法</li> <li>_notifyData 方法中，会遍历_onData 列表，根据条件会执行其泛型的 _data 的方法</li></ul> <p>下面看一下GetStream这个类</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">typedef</span> <span class="token class-name">OnData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// 继承自StreamSubscription 意味着可以处理流</span>
<span class="token keyword">class</span> <span class="token class-name">LightSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">StreamSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">RemoveSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> _removeSubscription<span class="token punctuation">;</span>

  <span class="token class-name">LightSubscription</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_removeSubscription<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onPause<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onResume<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onCancel<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onPause<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onResume<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onCancel<span class="token punctuation">;</span>

  bool<span class="token operator">?</span> cancelOnError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_removeSubscription</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    onCancel<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">OnData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> _data<span class="token punctuation">;</span>

  <span class="token class-name">Function</span><span class="token operator">?</span> _onError<span class="token punctuation">;</span>

  <span class="token class-name">Callback</span><span class="token operator">?</span> _onDone<span class="token punctuation">;</span>

  bool _isPaused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">onData</span><span class="token punctuation">(</span><span class="token class-name">OnData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> handleData<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _data <span class="token operator">=</span> handleData<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token operator">?</span> handleError<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _onError <span class="token operator">=</span> handleError<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token class-name">Callback</span><span class="token operator">?</span> handleDone<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _onDone <span class="token operator">=</span> handleDone<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> resumeSignal<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _isPaused <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    onPause<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _isPaused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    onResume<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token keyword">get</span> isPaused <span class="token operator">=</span><span class="token operator">&gt;</span> _isPaused<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> asFuture<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">E</span><span class="token operator">?</span> futureValue<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>futureValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 继承自Stream 意味着就是流对象</span>
<span class="token keyword">class</span> <span class="token class-name">GetStreamTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">AddSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> _addSubscription<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">RemoveSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> _removeSubscription<span class="token punctuation">;</span>

  <span class="token class-name">GetStreamTransformation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_addSubscription<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_removeSubscription<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">LightSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span> event<span class="token punctuation">)</span><span class="token operator">?</span> onData<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Function</span><span class="token operator">?</span> onError<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onDone<span class="token punctuation">,</span> bool<span class="token operator">?</span> cancelOnError<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> subs <span class="token operator">=</span> <span class="token class-name">LightSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>_removeSubscription<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">onData</span><span class="token punctuation">(</span>onData<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>onError<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">onDone</span><span class="token punctuation">(</span>onDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_addSubscription</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> subs<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">GetStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onListen<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onPause<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onResume<span class="token punctuation">;</span>
  <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onCancel<span class="token punctuation">;</span>

  <span class="token class-name">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onListen<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onPause<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onResume<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onCancel<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// 待刷新元素 _onData列表</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LightSubscription</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> _onData <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LightSubscription</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  bool<span class="token operator">?</span> _isBusy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">removeSubscription</span><span class="token punctuation">(</span><span class="token class-name">LightSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> subs<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isBusy<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _onData<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> _onData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// 加上监听</span>
  <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">addSubscription</span><span class="token punctuation">(</span><span class="token class-name">LightSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> subs<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isBusy<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _onData<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span>zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> _onData<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  int<span class="token operator">?</span> <span class="token keyword">get</span> length <span class="token operator">=</span><span class="token operator">&gt;</span> _onData<span class="token operator">?</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

  bool <span class="token keyword">get</span> hasListeners <span class="token operator">=</span><span class="token operator">&gt;</span> _onData<span class="token operator">!</span><span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">;</span>

  <span class="token comment">/// 遍历_onData列表元素 猜测_data方法中 应该有setState</span>
  <span class="token keyword">void</span> <span class="token function">_notifyData</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _isBusy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> item <span class="token keyword">in</span> _onData<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span>_data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    _isBusy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_notifyError</span><span class="token punctuation">(</span><span class="token class-name">Object</span> error<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name">StackTrace</span><span class="token operator">?</span> stackTrace<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>isClosed<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'You cannot add errors to a closed stream.'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _isBusy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> itemsToRemove <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LightSubscription</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> item <span class="token keyword">in</span> _onData<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stackTrace <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          item<span class="token punctuation">.</span>_onError<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> stackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          item<span class="token punctuation">.</span>_onError<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>cancelOnError <span class="token operator">?</span><span class="token operator">?</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//item.cancel?.call();</span>
          itemsToRemove<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
          item<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          item<span class="token punctuation">.</span>_onDone<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> item <span class="token keyword">in</span> itemsToRemove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _onData<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _isBusy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_notifyDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>isClosed<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'You cannot close a closed stream.'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _isBusy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> item <span class="token keyword">in</span> _onData<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span>_onDone<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    _isBusy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">T</span><span class="token operator">?</span> _value<span class="token punctuation">;</span>

  <span class="token class-name">T</span><span class="token operator">?</span> <span class="token keyword">get</span> value <span class="token operator">=</span><span class="token operator">&gt;</span> _value<span class="token punctuation">;</span>

  <span class="token comment">/// 调用add后 再调用_notifyData</span>
  <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">T</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>isClosed<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'You cannot add event to closed Stream'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _value <span class="token operator">=</span> event<span class="token punctuation">;</span>

    <span class="token comment">/// 开始刷新状态</span>
    <span class="token function">_notifyData</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool <span class="token keyword">get</span> isClosed <span class="token operator">=</span><span class="token operator">&gt;</span> _onData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">addError</span><span class="token punctuation">(</span><span class="token class-name">Object</span> error<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name">StackTrace</span><span class="token operator">?</span> stackTrace<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>isClosed<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'You cannot add error to closed Stream'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_notifyError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> stackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>isClosed<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'You cannot close a closed Stream'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_notifyDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _onData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    _isBusy <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    _value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">LightSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span> event<span class="token punctuation">)</span> onData<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Function</span><span class="token operator">?</span> onError<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onDone<span class="token punctuation">,</span> bool<span class="token operator">?</span> cancelOnError<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> subs <span class="token operator">=</span> <span class="token class-name">LightSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
      removeSubscription<span class="token punctuation">,</span>
      onPause<span class="token punctuation">:</span> onPause<span class="token punctuation">,</span>
      onResume<span class="token punctuation">:</span> onResume<span class="token punctuation">,</span>
      onCancel<span class="token punctuation">:</span> onCancel<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment">/// .. 相当于给对象设置成员属性或者成员方法</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">onData</span><span class="token punctuation">(</span>onData<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>onError<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">onDone</span><span class="token punctuation">(</span>onDone<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>cancelOnError <span class="token operator">=</span> cancelOnError<span class="token punctuation">;</span>

    <span class="token comment">/// _onData列表加上 该流的处理对象</span>
    <span class="token function">addSubscription</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    onListen<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> subs<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">get</span> stream <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token class-name">GetStreamTransformation</span><span class="token punctuation">(</span>addSubscription<span class="token punctuation">,</span> removeSubscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br></div></div><p>总结Rx&lt;T&gt;内置了GetStream实例，添加callBack回调，外部可以手动触发，
使用set Value时，会触发 subject.add(_value), 内部就是自动刷新，
使用get Value就是添加监听操作</p> <h5 id="obx组件"><a href="#obx组件" class="header-anchor">#</a> Obx组件</h5> <p>先看一下Obx的代码</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">typedef</span> <span class="token class-name">WidgetCallback</span> <span class="token operator">=</span> <span class="token class-name">Widget</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Obx</span> <span class="token keyword">extends</span> <span class="token class-name">ObxWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">WidgetCallback</span> builder<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token class-name">Obx</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>builder<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ObxValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">RxInterface</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ObxWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">Widget</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> builder<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token class-name">ObxValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>builder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">builder</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 说明obx实际上也是 statefulWidget</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ObxWidget</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token class-name">ObxWidget</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Key</span><span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">debugFillProperties</span><span class="token punctuation">(</span><span class="token class-name">DiagnosticPropertiesBuilder</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">debugFillProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    properties<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ObjectFlagProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Function</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'builder'</span></span><span class="token punctuation">,</span> build<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">ObxState</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">ObxState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@protected</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ObxState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObxWidget</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token comment">/// 实例化一个 RxNotifier() 对象， 称为 _observer</span>
  <span class="token comment">/// class RxNotifier&lt;T&gt; = RxInterface&lt;T&gt; with NotifyManager&lt;T&gt;;</span>
  <span class="token keyword">final</span> _observer <span class="token operator">=</span> <span class="token class-name">RxNotifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  late <span class="token class-name">StreamSubscription</span> subs<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 初始化时 将setState 传到_observer的监听方法中 -&gt; 引出疑问 RxNotifier 到底是什么呢</span>
    <span class="token comment">/// _updateTree 是传入的 onData方法</span>
    subs <span class="token operator">=</span> _observer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>_updateTree<span class="token punctuation">,</span> cancelOnError<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 这里 源码走几步看看</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_updateTree</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subs<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _observer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token class-name">RxInterface</span><span class="token punctuation">.</span><span class="token function">notifyChildren</span><span class="token punctuation">(</span>_observer<span class="token punctuation">,</span> widget<span class="token punctuation">.</span>build<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>现在_observer拿到了这个obx组件的更新ui的方法，现在要将这个监听对象转移出去</p> <p>接着看方法 -&gt; RxInterface.notifyChildren(_observer, widget.build);</p> <p>看类RxInterface</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">/// 英文注释 说了啥</span>
<span class="token comment">/// 这个类是所有响应式(Rx)类的基础，正是这些类让Get变得如此强大。</span>
<span class="token comment">/// 这个接口是 _RxImpl&lt;T&gt; 在它的所有子类中使用的约定。</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RxInterface</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token class-name">RxInterface</span><span class="token operator">?</span> proxy<span class="token punctuation">;</span>

  bool <span class="token keyword">get</span> canUpdate<span class="token punctuation">;</span>

  <span class="token comment">/// Adds a listener to stream</span>
  <span class="token keyword">void</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">GetStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> rxGetx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Close the Rx Variable</span>
  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Calls `callback` with current value, when the value changes.</span>
  <span class="token class-name">StreamSubscription</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">T</span> event<span class="token punctuation">)</span> onData<span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token class-name">Function</span><span class="token operator">?</span> onError<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> onDone<span class="token punctuation">,</span> bool<span class="token operator">?</span> cancelOnError<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Avoids an unsafe usage of the `proxy`</span>
  <span class="token keyword">static</span> <span class="token class-name">T</span> notifyChildren<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">RxNotifier</span> observer<span class="token punctuation">,</span> <span class="token class-name">ValueGetter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/// RxInterface.proxy正常情况为空，但是作为中间变量，可能出现暂存对象的情况</span>
    <span class="token comment">/// 现在暂时将它的对象取出来，存在oldObserver变量中</span>
    <span class="token keyword">final</span> oldObserver <span class="token operator">=</span> <span class="token class-name">RxInterface</span><span class="token punctuation">.</span>proxy<span class="token punctuation">;</span>

    <span class="token comment">/// 将在 _ObxState类中实例化的 RxNotifier() 对象的地址赋值给了RxInterface.proxy</span>
    <span class="token class-name">RxInterface</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> observer<span class="token punctuation">;</span>

    <span class="token comment">/// 调用我们在外部传进的Widget</span>
    <span class="token comment">/// 如果这个Widget中有响应式变量，那么一定会调用该变量中获取 get value（不然ui怎么显示出来）</span>
    <span class="token comment">/// 标识 &lt;getValue&gt; -&gt; 跳转到最最最重要！的一步</span>
    <span class="token comment">/// 在这里终于建立起联系了，将变量中 GetStream 实例，添加到了Obx中的 RxNotifier() 实例；</span>
    <span class="token comment">/// RxNotifier()实例中有一个 subject(GetStream) 实例，</span>
    <span class="token comment">/// Rx类型中数据变化会触发 subject 变化，最终刷新Obx</span>
    <span class="token keyword">final</span> result <span class="token operator">=</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 如果我们传入的Widget中没有Rx类型变量， _subscriptions数组就会为空，这个判断就会过不了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>observer<span class="token punctuation">.</span>canUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">RxInterface</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> oldObserver<span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token string-literal"><span class="token string">&quot;&quot;&quot;
      [Get] the improper use of a GetX has been detected. 
      You should only use GetX or Obx for the specific widget that will be updated.
      If you are seeing this error, you probably did not insert any observable variables into GetX/Obx 
      or insert them outside the scope that GetX considers suitable for an update 
      (example: GetX =&gt; HeavyWidget =&gt; variableObservable).
      If you need to update a parent widget and a child widget, wrap each one in an Obx/GetX.
      &quot;&quot;&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 最后将RxInterface.proxy中原来的值，重新赋给自己，</span>
    <span class="token comment">/// 至此 _ObxState 中的 _observer对象地址，进行了一番奇幻旅游后，结束了自己的使命（掘金作者原话）</span>
    <span class="token class-name">RxInterface</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> oldObserver<span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h5 id="obx总结"><a href="#obx总结" class="header-anchor">#</a> Obx总结</h5> <p>总的来说，Obx的刷新机制是GetX框架的核心之一，它使我们能够非常容易地在状态改变时更新UI，而不需要显式地调用setState等方法。</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2024/11/22 17:43:46</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/fang_blog/blogs/%E7%A7%BB%E5%8A%A8%E7%AB%AF/flutter/getx/getx%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6.html#总结" class="sidebar-link reco-side-总结" data-v-b57cc07c>总结</a></li><li class="level-3" data-v-b57cc07c><a href="/fang_blog/blogs/%E7%A7%BB%E5%8A%A8%E7%AB%AF/flutter/getx/getx%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6.html#依赖注入" class="sidebar-link reco-side-依赖注入" data-v-b57cc07c>依赖注入</a></li><li class="level-3" data-v-b57cc07c><a href="/fang_blog/blogs/%E7%A7%BB%E5%8A%A8%E7%AB%AF/flutter/getx/getx%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6.html#刷新机制" class="sidebar-link reco-side-刷新机制" data-v-b57cc07c>刷新机制</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/fang_blog/assets/js/app.8dbc3baf.js" defer></script><script src="/fang_blog/assets/js/3.d5c9c33c.js" defer></script><script src="/fang_blog/assets/js/1.3f023f4a.js" defer></script><script src="/fang_blog/assets/js/94.1dbfc8cd.js" defer></script>
  </body>
</html>
